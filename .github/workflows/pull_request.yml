name: Build and Test

on: pull_request

permissions:
  contents: read

jobs:
  lint:
    if: github.repository == 'ml-explore/mlx-swift'
    runs-on: ubuntu-latest
    container:
      image: swift:6.2-rhel-ubi9
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup uv
        uses: astral-sh/setup-uv@v6
        with:
          activate-environment: true

      - name: Setup pre-commit
        shell: sh
        run: |
          uv pip install pre-commit

      - name: Get swift-format tag
        id: swift-format
        shell: sh
        run: |
          cd /tmp
          LATEST_TAG=$(curl -s https://api.github.com/repos/swiftlang/swift-format/releases/latest | \
            grep '"tag_name":' | \
            sed -E 's/.*"([^"]+)".*/\1/')
          echo "swift-format $LATEST_TAG"
          echo "SWIFT_FORMAT_VERSION=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Cache swift-format build
        uses: actions/cache@v4
        id: cache-swift-format
        with:
          path: /tmp/swift-format/.build
          key: ${{ runner.os }}-swift-format-build-${{ steps.swift-format.outputs.SWIFT_FORMAT_VERSION }}

      - name: Build swift-format
        if: steps.cache-swift-format.outputs.cache-hit != 'true'
        shell: sh
        run: |
          cd /tmp
          git clone --branch ${{ steps.swift-format.outputs.SWIFT_FORMAT_VERSION }} --depth 1 https://github.com/swiftlang/swift-format.git
          cd swift-format
          swift build -c release

      - name: Link swift-format to /usr/local/bin
        shell: sh
        run: |
          cd /tmp/swift-format
          ln -s "$(swift build --show-bin-path -c release)/swift-format" /usr/local/bin/swift-format

      - name: Configure safe directory for git
        shell: sh
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Run style checks
        shell: sh
        run: |
          pre-commit run --all || (echo "Style checks failed, please install pre-commit and run pre-commit run --all and push the change"; echo ""; git --no-pager diff; exit 1)

  mac_build_and_test:
    needs: lint
    if: github.repository == 'ml-explore/mlx-swift'
    runs-on: [self-hosted, macos]
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Verify MetalToolchain installed
        shell: bash
        run: xcodebuild -showComponent MetalToolchain

      - name: Setup cmake
        shell: sh
        run: |
          brew install cmake ninja

      - name: Build SwiftPM (Xcode, macOS)
        shell: sh
        env:
          # workaround for CI failure
          DEVELOPER_DIR: /Applications/Xcode-latest.app
        run: |
          xcodebuild -version
          xcrun --show-sdk-build-version
          swift --version
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          xcodebuild build-for-testing -scheme mlx-swift-Package -destination 'platform=macOS'

      - name: Run Tests SwiftPM (Xcode, macOS)
        shell: sh
        env:
          # workaround for CI failure
          DEVELOPER_DIR: /Applications/Xcode-latest.app
        run: |
          xcrun xctest ~/Library/Developer/Xcode/DerivedData/mlx-swift-*/Build/Products/Debug/CmlxTests.xctest
          xcrun xctest ~/Library/Developer/Xcode/DerivedData/mlx-swift-*/Build/Products/Debug/MLXTests.xctest

      - name: Build xcodeproj (Xcode, macOS)
        shell: sh
        env:
          # workaround for CI failure
          DEVELOPER_DIR: /Applications/Xcode-latest.app
        run: |
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          cd xcode
          xcodebuild build-for-testing -scheme MLX -destination 'platform=macOS'

      - name: Run Tests xcodeproj (Xcode, macOS)
        env:
          # workaround for CI failure
          DEVELOPER_DIR: /Applications/Xcode-latest.app
        working-directory: xcode
        run: ../.github/scripts/run-xcode-tests.sh

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/Logs/Test/*.xcresult
            /Users/runner/Library/Developer/Xcode/DerivedData/**/Logs/Test/*.xcresult
            ~/Library/Logs/DiagnosticReports/*
          retention-days: 7

      - name: Build (cmake)
        shell: sh
        run: |
          rm -rf build
          mkdir build
          cd build
          cmake .. -G Ninja
          ninja

  linux_build_cmake_container:
    name: Linux Container CMake Swift Build (${{ matrix.container }} ${{ matrix.arch }})
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        include:
          # See https://github.com/swiftlang/swift-docker/tree/main/
          - host: ubuntu-22.04
            arch: x86_64
            container: swift:bookworm
          - host: ubuntu-22.04
            arch: x86_64
            container: swift:fedora39
          - host: ubuntu-22.04-arm
            arch: aarch64
            container: swift:bookworm
          - host: ubuntu-22.04-arm
            arch: aarch64
            container: swift:fedora39

    runs-on: ${{ matrix.host }}
    container:
      image: ${{ matrix.container }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Linux Container CMake Swift Build - No Release
        run: |
          bash .github/scripts/setup+build-linux-container-cmake.sh

  linux_build_cmake_cuda:
    name: Linux CUDA CMake Swift Build (cuda-12.9, swift-6.2.3-RELEASE, ubuntu-24.04, x86_64)
    needs: lint
    runs-on: "gpu-t4-4-core"
    env:
      # Note 12/18/2025: the CI machine does not meet CUDA 13's driver requirement.
      # Compatibility matrix:
      # https://docs.nvidia.com/deeplearning/cudnn/backend/latest/reference/support-matrix.html
      TOOLKIT_VERSION: "cuda-12.9"
      SWIFT_VERSION: "swift-6.2.3-RELEASE"
      # pub   rsa4096 2024-09-16 [SC] [expires: 2026-09-16]
      #      52BB7E3DE28A71BE22EC05FFEF80A866B47A981F
      # uid           [ unknown] Swift 6.x Release Signing Key <swift-infrastructure@forums.swift.org>
      SWIFT_SIGNING_KEY: "52BB7E3DE28A71BE22EC05FFEF80A866B47A981F"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Linux CUDA Setup
        run: |
          bash .github/scripts/setup-linux-cuda.sh

      - name: Linux CUDA CMake Swift Build - No Release
        run: |
          bash .github/scripts/build-linux-cuda-cmake.sh
